<html>
<head>
	<title>Startup Data Visualization - Angela Wu, Val Mack, Rong Hu</title>
	<link rel="stylesheet" href="main.css"/>
	<link rel="stylesheet" href="fig2.css"/>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
	<script src="uStates.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
	<script src="sankey.js"></script>
	
	<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
</head>
<body>
	<div class="intro">
		<h1>US Startups 2017</h1>
		<p>INFO 5100 Project 2 <br>Angela Wu, Rong Hu and Val Mack</p>
		<hr/>
	</div>
	<div class="main">
		<div class="fig1">
			<div class="info">
				<h3>Location, Fund & Market </h3>
				<div>Key Markets:<br/>
				<select id="select-list">
				  <option value="v1">E-Commerce</option> 
				  <option value="v2">Education</option>
				  <option value="v3">Enterprise Software</option>
				  <option value="v4">Game</option>
				</select>
				</div>
				<h4>Startups at California and New York raise at least 70% of funding in each key market. Most of the funding of these two states are given to Enterprise Software market. Game startups are centered in a small number of states while other markets are more widely spread across US. </h4>
				<p>The map shows the location and fund distributions of the top 100 statups in the specific key market. The colors represent the total fund that the startups raise. The pie graph shows the funding distributions among key markets in each state.<br><br></p>	
				<svg width="200" height="200" viewBox="0 0 200 200" id="fig1c"></svg>		
			</div>
			<div id="tooltip"></div><!-- div to hold tooltip. -->
			<svg width="75%" height="700" viewBox="0 0 960 600" id="fig1">
			</svg>	

		</div>
		<div id="fig2">
			<div class="info">
				<h3>Startup Talent Sources</h3>
				<div>Please choose:<br/>
				<select id="select">
				  <option value="0">Top Universities</option> 
				  <option value="1">Top Companies</option>
				</select>
				</div>
				<h4>Top Startup talent sources: UC Berkeley, Standford University, Google, and Microsoft.</h4>
				<p>The graph shows the number of startups with team members from a certain top university or major company, as well as the composition of total startups based on total funding raised.</p> 
				<p>The <span>depth</span> of the rectangle represents the number of startups.</p>
				<p>Pay attention to the " Team Source". Universities are classified into two categories: east and west coasts, and companies are grouped into three industries. Each category is represented with different <span>colors</span>.</p>
				<p><span>Click</span> to see all all the links.<br>
				   <span>Hover</span> to see all details.</p>

			</div>
			<div id="title"></div>
			<svg id="university" width="75%" height="900" viewBox="0 0 960 900"></svg>
		</div>

		<div class="fig3">
			<div class="info">
				<h3>SIZE</h3>
				<h4>The majority of startups have at most 200 employees.</h4>
				<p>Companies listed for each circle have at most <i>n</i> employees, where <i>n</i> is the number that appears when you hover over a circle. The radius of each circle represents the relative difference in company size between groups of companies. The width of each circumference is the relative amount of companies with <i>n</i> employees.</p>
			</div>
			<svg id="fig3"></svg>
		</div>
	</div>

	
	<script>
		// globals
		var width = "75%";
		var height = "500";
		var backgroundColor = "#f5f5f5";
		

		/* BEGIN FIGURE 1 */
		//http://htmlcolorcodes.com/
		var colors = [["#EBF5FB", "#AED6F1", "#21618C", "#1B4F72"], ["#EAFAF1", "#ABEBC6", "#1D8348", "#186A3B"], ["#FEF9E7", "#F9E79F", "#9A7D0A", "#7D6608"], ["#FDEDEC", "#F5B7B1", "#943126", "#78281F"]];
		var indData = ["ec.csv", "edu.csv", "es.csv", "game.csv"];
		var isFirst = true;

		var data = getData(0);

		d3.select("#select-list").on("change", function(){
			var selectedIndex = d3.event.target.selectedIndex;

			data = getData(selectedIndex);
		});

		function getData(k) {
			d3.csv(indData[k], function (error, rawData) {
				d3.csv("market.csv", function(error, data) {
			if (error) { console.log(error); }

			var temp = rawData;
			var data = data;
			var sampleData ={};

			var maxRevenue = d3.max(temp, function(d){return +d.Revenue;});

			var secondRevenue = d3.max(temp, function(d){
				if (+d.Revenue !=  maxRevenue) {
					return +d.Revenue;
				} else return 0;
			});

			var findColor = function(revenue) {
				if (revenue == 0) {
					return colors[k][0];
				} else if (revenue == maxRevenue) {
					return colors[k][3];
				} else {
					return d3.interpolate(colors[k][1], colors[k][2])(revenue/secondRevenue); 
				} 
			}

			temp.forEach(function(d){ 
				var count=+d.Count, 
					revenue=+d.Revenue;
				sampleData[d.State]={count:count, revenue:revenue, color: findColor(revenue)}	
			});

			if (isFirst) {
				uStates.draw("#fig1", sampleData, tooltipHtml);
				isFirst = false;
				mousefunc();
			} else {
				mousefunc();
			}

			function mousefunc() {
				d3.select("#fig1").selectAll(".state").style("fill",function(d){ return sampleData[d.id].color; }).on("mouseover", mouseOver);

			    function mouseOver(d){
				d3.select("#tooltip").transition().duration(200).style("opacity", .9);      
				
				d3.select("#tooltip").html(tooltipHtml(d.n, sampleData[d.id]))  
					.style("left", (d3.event.pageX) + "px")     
					.style("top", (d3.event.pageY - 28) + "px");

				drawCircle(d.id);
		        } 
			}

			var drawCircle = function(state) {

				var width = 200,
				    height = 200,
				    radius = Math.min(width, height) / 2;

				var color = ["#5DADE2", "#58D68D", "#F4D03F", "#EC7063"];

				var arc = d3.arc()
				    .outerRadius(radius - 10)
				    .innerRadius(radius - 70);

				var pie = d3.pie()
				    .sort(null)
				    .value(function(d) { return +d[state]; });

				var svg = d3.select("#fig1c");
				svg.selectAll("*").remove();

				var svg = d3.select("#fig1c").append("svg")
				    .attr("width", width)
				    .attr("height", height)
				    .append("g")
				    .attr("transform", "translate(" + width / 2 + "," + (height + 10) / 2 + ")");

				var name = function(d) {
					if (d.data[state] == 0) return "";
					return d.data.State;
				}

				  var g = svg.selectAll(".arc")
				      .data(pie(data))
				      .enter().append("g")
				      .attr("class", "arc");

				  g.append("path")
				      .attr("d", arc)
				      .style("fill", function(d, i) { return color[i]; });

				  svg.append("text")
			        .attr("x", 0)             
			        .attr("y", -95)
			        .attr("text-anchor", "middle")  
			        .style("font-size", "12px") 
			        .text("Funding distribution of " + state);

				  g.append("text")
				      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
				      .attr("dy", ".35em")
				      .style("font-size", "9px")
				      .text(function(d) { 
				      	return name(d); 
				      });
				}
			});
			});
		}

		function tooltipHtml(n, d){	/* function to create html content string in tooltip div. */
			if (d.revenue == 0) {
				return "<h4>"+n+"</h4><table>"+
				"<tr><td>Count</td><td>"+(d.count)+"</td></tr>"+
				"<tr><td>Funding</td><td>"+("$"+(0))+"</td></tr>"
				"</table>";
			} else {
				return "<h4>"+n+"</h4><table>"+
				"<tr><td>Count</td><td>"+(d.count)+"</td></tr>"+
				"<tr><td>Funding</td><td>"+("$"+(d.revenue/1000000).toFixed(0)+"M")+"</td></tr>"
				"</table>";
			}
		}

		/*BEGIN FIGURE 2 */
		var margin = {top: 100, right: 70, bottom: 50, left: 50};
		var S_width = 800,S_height = 600;

		var formatNumber = d3.format(",.0f");    // zero decimal places
    	var	format = function(d) { return formatNumber(d) + " "; };
    	//var color = d3.scaleOrdinal(d3.schemeCategory20);
    	var color = d3.scaleOrdinal().domain(['t','e','w','i','c','f'])
    	                             .range(["#FFD700", "#FF0000","#4169E1","#984ea3","#ff7f00","#DC143C"]);
    	

		// Set the sankey diagram properties
		var sankey = d3.sankey()
    				.nodeWidth(40)
    				.nodePadding(20)
    				.size([S_width, S_height]);

		var path = sankey.link();

		function removeDuplicates(num) {
    		var x,
        	len=num.length,
        	out=[],
        	obj={};
                 
    		for (x=0; x<len; x++) {
        		obj[num[x]]=0;
    		}	
    		for (x in obj) {
        		out.push(x);
    		}
    		return out;
		}

		function prepareData(data) {
    		//set up graph objects
    		graph = {"nodes" : [], "links" : []};

    		data.forEach(function (d) {
        		graph.nodes.push({ "name": d.source });
        		graph.nodes.push({ "name": d.target });
        		graph.links.push({ "source": d.source,
                           		   "target": d.target,
                                   "value": d.value });
    		});
    		// return only the distinct / unique nodes
   			nodesArray=[];
    		graph.nodes.forEach(function(d) {
        	nodesArray.push(d.name);
    		});

    		console.log(nodesArray);
            
    		graph.nodes = removeDuplicates(nodesArray);
    		console.log(graph.nodes);
            
    		// loop through each link replacing the text with its index from node
    		graph.links.forEach(function (d, i) {
        	graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
        	graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
    		});

    		//now loop through each nodes to make nodes an array of objects rather than an array of strings
    		graph.nodes.forEach(function (d, i) {
        	graph.nodes[i] = { "name": d };
    		});

    		return graph;
		}
		var datasets = ["teams.csv","companies.csv"];
		var info = [["East Coast University","West Coast University"],["IT Firm","Consulting Firm","Financial Firm"]];

		// load the data and plot figure
		var choice = d3.select("#select");
		choice.on("change", function(){
			d3.selectAll("#university > *").remove();
			var index = choice.property("value");
			console.log(index);
			var inputData = datasets[index];
			showSankey(inputData);
		})

		// default graph
		showSankey("teams.csv");
		
		function showSankey(inputData){
			d3.csv(inputData, function(error, data) {
    
    		var graph = prepareData(data);

    		sankey.nodes(graph.nodes)
          		  .links(graph.links)
          		  .layout(0);

    		console.log(graph.links);


    		var svg_uni = d3.select("#university");
    		// plot the graph
    		// add in the links
    		var link = svg_uni.append("g").selectAll(".link")
                      .data(graph.links)
                      .enter().append("path")
                      .attr("class", "link")
                      .attr("d", path)
                      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
                      .style("display","none")
                      .attr("transform", "translate("+margin.right + ","+ margin.top+")")
                      .on("mouseover", function(d){
                      		d3.select("#title").transition().duration(200).style("opacity", .9);      
      
            				d3.select("#title").html(function (){
            					return "Number of Startups: " + format(d.value);});
            		});

            // add link titles **
            //link.append("title")
                //.text(function(d) {
                      // return format(d.value) + " startups with teammembers graduated from " + 
                          // d.target.name.substring(2); });
    		// add in the nodes
    		var clickTwice = false;
    		var node = svg_uni.append("g").selectAll(".node")
                      .data(graph.nodes)
                      .enter().append("g")
                      .attr("class", "node")
                      .attr("transform", function(d) { 
                            var tran_x = d.x + margin.right;
                            var tran_y = d.y + margin.top;
                            return "translate(" + tran_x + "," + tran_y + ")";
                        })
                      .on("click", function(data){
                              if(clickTwice){
                                  //var node = d;
                                  var showLinks = d3.selectAll(".link").filter(function(d){return d.source==data || d.target==data;});
                                  showLinks.style("display", "none");
                                  clickTwice = false;
                              }else {
                                  //node = d;
                                  showLinks = d3.selectAll(".link").filter(function(d){return d.source==data || d.target==data;});
                                  showLinks.style("display", null);
                                  clickTwice = true;}
                      });

    		// add the rectangles for the nodes
    		node.append("rect")
        		.attr("height", function(d) { return d.dy; })
        		.attr("width", sankey.nodeWidth())
       			.style("fill",
       			function(d) { 
                	return d.color = color(d.name.substring(0,2)); 
        	}
        	)
        		.on("mouseover", function(d) {
            		d3.select("#title").transition().duration(200).style("opacity", .9);      
      
            		d3.select("#title").html(function (){
              				return  "<span>" + d.name.substring(2)+ "</span>" + "<br>"+ "Number of Startups: " + d.value;
              			})  
              	.style("left", (d3.event.pageX) + "px")     
              	.style("top", (d3.event.pageY - 28) + "px");

        	})

        	// function for displaying legend
        	function showLegend(inputInfo) {
        		//add in color legend for connection nodes
				var legend = d3.select("#university").append("g").attr("class",".legend");
					
					legend.selectAll("rect")
			  		.data(inputInfo).enter()
			  		.append("rect")
			  		.attr("x",function(d,i){
			  		//return 900 -40-40-140*(inputInfo.length-i-1)
			  		return 70 + 180*i;})
			  		.attr("y",750)
			  		.attr("width",40)
			  		.attr("height",20)
			  		.style("fill", function(d){return color(d.substring(0,1).toLowerCase());});
			  		
			  		legend.selectAll("text")
			  		.data(inputInfo).enter()
			  		.append("text")
			  		.text(function(d) {return d;})
			  		.attr("text-anchor", "middle")
			  		.attr("font-size", 13)
			  		.attr("y",800)
			  		.attr("x", function(d,i)
			  						{//return 900 -60-140*(inputInfo.length-i-1)
			  						 return 90 + 180*i;});
        	}

        	//show legend
        	var index = choice.property("value");
        	var legendData = info[index];
        	showLegend(legendData);
        	

    		// add category labels
    		var labels = ["Team Source", "Funding Status", "Total Startups"];

    		var label = svg_uni.append("g").selectAll(".label")
    					.data(labels).enter()
          				.append("g")
          				.attr("class", "label")
                      	.attr("transform", function(d,i) { 
                            var tran_x = 30 + 380 * i;
                            return "translate(" + tran_x + "," + "30" + ")";
                        })

    		label.append("rect")
          				.attr("width",120)
          				.attr("height",50)
          				.attr("rx",10)
          				.attr("ry",10)
          				.style("fill-opacity", 0)
          				.style("stroke", "black")
          				.style("stroke-width",2);
          	label.append("text")
          		 .text(function(d){return d;})
          		 .attr("y",30)
        		 .attr("text-anchor", "middle")
        		 .attr("transform","translate(60,0)");
    
            });
		}



		
		/* BEGIN FIGURE 3 */
		// scales
		var employeesScale = d3.scaleSqrt().domain([0, 5000]).range([20, 400]);
		var companiesScale = d3.scaleLinear().domain([0, 53]).range([.2, 24]);
		
		var f3 = d3.select("#fig3").attr("width", width).attr("height", height).append("g").attr("transform", "translate(80,0)");
		
		var widthFloat = parseFloat(d3.select("#fig3").style("width"));
		var rawData;
		var companiesBySize;
		
		function parse(row) {
			if (row.Employees) {
				var dash = row.Employees.indexOf("-");
				console.log(row.Employees);
				row.Employees = parseFloat(row.Employees.slice(dash+1));
				return row;
			}
		}
		
		// test load
		var testData, testBySize;
		
		d3.csv("100companies_employees.csv", function(error, data) {
			if (error) { console.log(error); }
			
			testData = data;
			
			testBySize = d3.nest()
			.key(function(d) {return d.Employees;})
			.entries(testData);
			
		});
		
		// load data
		
		d3.csv("100companies_employees.csv", parse, function (error, data) {
			if (error) { console.log(error); }
			
			rawData = data;
			
			companiesBySize = d3.nest()
			.key(function (d) { return d.Employees; })
			.entries(rawData);
			
			var circles = f3.selectAll("circle")
			.data(companiesBySize)
			.enter()
			.append("circle")
			.attr("cx", widthFloat/2)
			.attr("cy", height/2)
			.attr("fill", backgroundColor)
			.attr("stroke", "steelblue")
			.attr("r", function(d) {
				// employee size
				return employeesScale(d.key);
			})
//			.attr("stroke-width", function(d) {
//				// number of companies
//				return companiesScale(d.values.length);
//			})
			.on("mouseover", showData)
			.on("mouseout", hideData);
			
			var labels = f3.append("g")
			.attr("transform", "translate("+widthFloat/2+","+height/2+")");
			
			function showData(d) {
				//companies
				f3.append("text")
				.text(
					function() {
						var companies = [];
						d.values.forEach(function(c){
							companies.push(c.Name);
						});
						companies.forEach(function(i) {
							f3.append("text")
							.text(i)
							.attr("x", "-60")
							.attr("y", companies.indexOf(i)*16)
							.attr("fill", "white")
							.attr("transform", "translate(10,20)");
						})
					});
				//employees
				labels.append("text")
				.text(d.key)
				.style("font-size","14")
				.attr("x", -employeesScale(d.key)+(.1*employeesScale(d.key)))
				.attr("y", "-2")
				.attr("fill", "steelblue");
				//area
				d3.select(this).attr("fill", "steelblue");
				//radius
//				labels.append("line")
//				.style("stroke", "steelblue")
//				.attr("x1", -employeesScale(d.key))
//				.attr("y1","0")
//				.attr("x2", "0")
//				.attr("y2", "0");
			}
			
			function hideData(d) {
				f3.selectAll("text").remove();
				labels.selectAll("text").remove();
				labels.selectAll("line").remove();
				d3.select(this).attr("fill", backgroundColor);
			}
			
		});
		
		
		
	</script>
</body>
</html>